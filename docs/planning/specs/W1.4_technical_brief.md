# Technical Brief: Distance Metrics Implementation (Task W1.4)

**To:** RUST_ENGINEER
**From:** PLANNER
**Date:** 2025-12-06
**Subject:** Specification for Distance Metrics Module

## 1. Objective
Implement the core distance metrics used by the HNSW index. These are the "hot path" computations and must be efficient, correct, and `no_std` compatible.

## 2. Architecture Alignment
- **Module:** `src/metric/`
- **Traits:** Define a unified behavior for distance calculations.
- **Constraint:** Must compile to `wasm32-unknown-unknown`.

## 3. Required Implementations

### 3.1 The Trait
Define a trait that allows generic usage over vector types (f32 vs u8).

```rust
pub trait Metric<T> {
    fn distance(a: &[T], b: &[T]) -> f32;
}
```

### 3.2 L2 Squared (Euclidean)
- **Inputs:** `&[f32]`, `&[f32]`
- **Formula:** $\sum (a_i - b_i)^2$
- **Note:** Do NOT return the square root. HNSW works correctly with squared distances and avoids the expensive `sqrt` operation.
- **Stability:** Panic on `NaN`.

### 3.3 Dot Product
- **Inputs:** `&[f32]`, `&[f32]`
- **Formula:** $\sum (a_i \times b_i)$
- **Note:** Used for Cosine Similarity when vectors are normalized.
- **Stability:** Panic on `NaN`.

### 3.4 Hamming Distance
- **SALVAGE AUTHORIZED**
- **Source:** `binary_semantic_cache::similarity.rs` (lines 286-292)
- **Inputs:** `&[u8]`, `&[u8]` (packed binary)
- **Implementation:** XOR followed by `count_ones()`.
- **Attribution Required:**
  ```rust
  // Adapted from binary_semantic_cache v1.0 (MIT License)
  // Copyright (c) 2024 Matteo Panzeri
  // Original: https://github.com/[user]/binary_semantic_cache
  ```

## 4. Implementation Rules

1.  **No `std`:** Use `core` only.
2.  **SIMD:** Write clean loops that LLVM can auto-vectorize. Do not use explicit SIMD intrinsics (`std::arch`) yet unless absolutely necessary, as it complicates WASM builds.
3.  **Safety:**
    -   Panic if `a.len() != b.len()`.
    -   Panic if inputs contain `NaN` (for f32).
4.  **Testing:**
    -   Unit tests for basic correctness.
    -   Property tests (in `tests/`) to verify mathematical properties (symmetry, triangle inequality for L2).

## 5. Files to Create
- `src/metric/mod.rs` (Trait definition)
- `src/metric/l2.rs`
- `src/metric/dot.rs`
- `src/metric/hamming.rs`

## 6. Approval
This brief authorizes the implementation of the above specifications.

