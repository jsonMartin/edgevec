# EdgeVec Daily Task Guide â€” Day 18 (Week 4)

**Focus:** Storage Backend & IndexedDB (Chunked Strategy)
**Goal:** Implement scalable browser persistence that avoids Memory OOM and Blob limits.

---

## 1. Context
We need to persist up to 1M vectors (~100MB). Single-blob `IndexedDB` writes fail on many browsers (size limits) and cause OOM crashes (allocating contiguous 100MB buffers). We will use a **Chunked Writer** strategy.

## 2. Tasks

### T18.1: `StorageBackend` & Chunking Logic
Define the chunking constants and traits in `src/persistence/storage.rs`.

```rust
pub const CHUNK_SIZE: usize = 10 * 1024 * 1024; // 10MB

pub trait ChunkedWriter {
    // Returns an iterator that yields chunks to avoid creating one huge buffer
    fn export_chunked(&self) -> impl Iterator<Item = Vec<u8>>;
}
```

### T18.2: JS Adapter (Sequential Chunk Writer)
Implement the JS/WASM bridge to handle streams of data.
- **Problem:** We cannot allocate the full file in WASM memory.
- **Solution:**
  1. Rust exposes `get_chunk(index) -> Vec<u8>`.
  2. JS loop: calls `get_chunk`, writes to IDB (key: `snapshot_chunk_0`, `snapshot_chunk_1`...), frees memory, repeats.
  3. This ensures peak memory usage is `Total Size + 10MB`, not `Total Size * 2`.

### T18.3: `IndexedDbBackend` Implementation
- **Metadata:** Store a `manifest` key with `total_chunks`, `checksum`, `version`.
- **Async Write:** The `save()` operation is a JS-driven async loop that pulls chunks from WASM.

## 3. Constraints
- **Memory Safety:** Serialization MUST happen chunk-by-chunk (or use a sliding window). **DO NOT** serialize to a huge `Vec<u8>` and then slice it.
- **Atomicity:** Write the `manifest` LAST. If `manifest` exists, the snapshot is valid.
- **Async/Await:** Rust `save` will yield control or be driven by JS callbacks.

## 4. Verification
- **Test:** `test_chunked_export` (Unit): Verify data splits correctly at boundary.
- **Test:** `test_idb_large_write` (Integration): Simulate 100MB write (mocked) without OOM.
- **Metric:** Peak WASM memory usage during save must not spike > 20MB above baseline.
