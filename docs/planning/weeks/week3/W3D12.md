# Week 3 Day 12: Neighbor Management & VByte

**Date:** Tuesday
**Focus:** Memory-Efficient Neighbor Storage (Compressed + Recycled)

---

## 1. Context
- **Architecture:** `ARCHITECTURE.md` Section 3.4
- **Data Layout:** `DATA_LAYOUT.md` Section 3.3 (Compressed Neighbor Pool)
- **Constraint:** Must fit within <100 bytes/vector budget.
- **Correction:** "Append-only" is insufficient for graph updates. We must implement a free-list to recycle memory.

## 2. Implementation Tasks

### 2.1 NeighborPool (VByte + FreeList)
- [ ] Implement `NeighborPool` struct.
  - `buffer: Vec<u8>`
  - `free_list: BTreeMap<usize, Vec<usize>>` (Capacity -> List of Offsets)
- [ ] Implement `alloc(size: usize) -> (usize, usize)` (returns offset, capacity).
  - Check `free_list` for smallest capacity >= `size`.
  - If found: remove from free list, return.
  - If not found: append to buffer.
- [ ] Implement `free(offset: usize, capacity: usize)`.
  - Add to `free_list`.
- [ ] Implement `encode_neighbors(node_id, neighbors: &[NodeId]) -> Vec<u8>`.
  - Sort neighbors.
  - Compute deltas.
  - VByte encode.
- [ ] Implement `push` / `update` mechanism:
  - When updating neighbors, `free()` the old slot and `alloc()` a new one.

### 2.2 Heuristic Neighbor Selection
- [ ] Implement `select_neighbors(candidates, M, layer_type)`.
  - Simple heuristic first: Keep M closest.
  - **Constraint:** Use `VectorStorage` to compute distances.

## 3. Verification Strategy

### 3.1 Unit Tests
- `test_vbyte_encoding`: Manually verify bit patterns for known integers.
- `test_pool_recycling`:
  - Alloc 10 bytes -> Free -> Alloc 10 bytes.
  - Assert: Offset is same (memory reused).
  - Alloc 20 bytes.
  - Assert: Offset is new (too big for hole).

### 3.2 Property Tests (Proptest)
- `prop_neighbor_roundtrip`:
  - Generate random `Vec<NodeId>`.
  - Encode -> Decode.
  - Assert `decoded == original`.

### 3.3 Acceptance Criteria
- [ ] VByte encoding works correctly.
- [ ] Memory recycling verified (allocation counter does not grow linearly with updates).
- [ ] Memory overhead matches calculations in `DATA_LAYOUT.md` (<100 bytes/vec).

## 4. Estimates
- **Time:** 12 hours
- **Risk:** Medium (Fragmentation logic is trickier than append-only).
