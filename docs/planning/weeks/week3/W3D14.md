# Week 3 Day 14: Insertion & Wiring

**Date:** Thursday
**Focus:** Connecting the Graph (Algorithm 1)

---

## 1. Context
- **Architecture:** `ARCHITECTURE.md` Section 3.1 (Insert Flow)
- **Algorithm:** HNSW Algorithm 1 (`INSERT`)
- **Reference:** Malkov & Yashunin (2018)

## 2. Implementation Tasks

### 2.1 The Insert Loop
- [ ] Implement `HnswIndex::insert`.
  - **Signature:** `pub fn insert(&mut self, vector: &[f32], id: VectorId) -> Result<(), EdgeVecError>`
  - **Error Handling:** Propagate allocation failures or invalid config.
- [ ] **Step 1:** Determine level `L` for new node.
- [ ] **Step 2:** Search from top layer down to `L+1` to find entry point `ep`.
- [ ] **Step 3:** For layers `min(L, max_layer)` down to 0:
  - `search_layer(vector, ep, ef_construction)` -> candidates.
  - `select_neighbors(candidates, M)` -> neighbors.
  - **Bidirectional Connect:** Add link from new node to neighbor AND neighbor to new node.
  - Handle overflow: If neighbor now has > M connections, prune weakest.
  - **Safety:** Wrap updates in Result to handle `NeighborPool` OOM/Failure.

### 2.2 Connection Management
- [ ] Implement `add_connection(src, dst, layer) -> Result<(), EdgeVecError>`.
  - Read old neighbors.
  - Add new neighbor.
  - Select best M.
  - Write new list (triggering `NeighborPool::free` and `NeighborPool::alloc`).
  - Update `HnswNode` offset.

## 3. Verification Strategy

### 3.1 Unit Tests
- `test_insert_single`: Insert 1, check levels.
- `test_insert_pair`: Insert 2, check they connect.
- `test_insert_error_handling`: Mock a pool failure (optional) or config error.

### 3.2 Property Tests
- `prop_graph_connectivity`:
  - Insert N vectors.
  - Perform BFS from entry point.
  - Assert: All nodes are reachable (weakly connected).

### 3.3 Acceptance Criteria
- [ ] Insertion maintains graph invariants (max M neighbors).
- [ ] `NeighborPool` effectively reuses memory during updates (validated via internal metrics).
- [ ] No panics; all internal errors return `Result::Err`.
- [ ] Graph is navigable.

## 4. Estimates
- **Time:** 16 hours
- **Risk:** High (Complexity of bidirectional updates + Memory recycling).
