# Week 3 Day 11: HNSW Infrastructure & Layers

**Date:** Monday
**Focus:** HNSW Structs, Layer Generation, Entry Point Logic

---

## 1. Context
- **Architecture:** `ARCHITECTURE.md` Section 2.2 (Index Layer)
- **Data Layout:** `DATA_LAYOUT.md` Section 3 (HnswNode)
- **Goal:** Establish the spine of the graph before adding edges.

## 2. Implementation Tasks

### 2.1 Core Structures
- [ ] Define `HnswIndex` struct in `src/hnsw.rs`.
- [ ] Define `HnswNode` struct (matching `DATA_LAYOUT.md`).
- [ ] Implement `HnswConfig` validation.

### 2.2 Random Layer Generation
- [ ] Implement `get_random_level(m_l)`:
  - Formula: `floor(-ln(uniform(0,1)) * m_l)`
  - `m_l = 1 / ln(M)`
  - Use `DeterministicRng` (seeded).
- [ ] **Constraint:** Maximum level cap (e.g., 16) to prevent runaway memory.

### 2.3 Entry Point Management
- [ ] Implement `entry_point` field (Option<NodeId>).
- [ ] Logic to update entry point if new node has higher max layer.

## 3. Verification Strategy

### 3.1 Unit Tests
- `test_config_validation`: Reject invalid M/M0.
- `test_index_initialization`: Empty index has no entry point.

### 3.2 Property Tests (Proptest)
- `prop_layer_distribution`:
  - Generate 10,000 levels.
  - Verify distribution matches expectation (approx exponentially decaying).
  - Verify no level exceeds safely caps.

### 3.3 Acceptance Criteria
- [ ] `HnswIndex` compiles with correct layout.
- [ ] Layer generation is deterministic with same seed.
- [ ] Layer 0 probability is correct relative to M.

## 4. Estimates
- **Time:** 8 hours
- **Risk:** Low (Standard statistical implementation).

