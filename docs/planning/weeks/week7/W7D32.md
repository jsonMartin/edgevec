# W7D32 - Snapshot Management

## 1. Context
- **Objective:** Prevent indefinite WAL growth by compacting state into a "Snapshot".
- **Dependencies:** `WAL` replay (W7D31).
- **Success Criteria:** Can create a full state snapshot and truncate the WAL.

## 2. Technical Plan

### 2.1 Snapshot Workflow
1. **Trigger:** WAL size > Threshold (e.g., 10MB) or manual trigger.
2. **Serialize:** Dump entire `VectorStorage` (vectors + metadata) to a temporary file (`.snap.tmp`).
3. **Persist:** Rename `.snap.tmp` to `current.snap`.
4. **Truncate:** Clear/Reset the WAL file.

### 2.2 File Format (.snap)
- **Header:** Magic `EVSN` + Version + Timestamp.
- **Body:** Serialized `VectorStorage` (Postcard/bincode).
- **Footer:** Checksum.

### 2.3 Integration
Modify startup logic:
1. Load `current.snap` (if exists).
2. Replay `wal.log` (if exists).

## 3. Tasks (W7.2)
- [ ] Define `SnapshotHeader` struct.
- [ ] Implement `SnapshotManager::save(storage)`.
- [ ] Implement `SnapshotManager::load() -> storage`.
- [ ] Implement WAL truncation after successful snapshot.

## 4. Verification
- **Unit Test:** `test_snapshot_cycle`: Insert -> Snapshot -> Insert -> Restart -> Verify all data.
- **Size Check:** Ensure snapshot is smaller than raw WAL for updates.

