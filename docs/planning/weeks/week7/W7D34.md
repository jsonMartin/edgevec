# W7D34 - Error Handling Audit

## 1. Context
- **Objective:** Ensure all persistence errors are typed, meaningful, and propagated correctly. No panics.
- **Dependencies:** All Storage code.
- **Success Criteria:** No `unwrap()` in `src/storage/`.

## 2. Technical Plan

### 2.1 Error Taxonomy
Create/Refine `PersistenceError` enum:
```rust
#[derive(Debug, Error)]
pub enum PersistenceError {
    #[error("IO Error: {0}")]
    Io(#[from] std::io::Error),
    #[error("Serialization Error: {0}")]
    Serialization(#[from] postcard::Error),
    #[error("Checksum Mismatch: expected {expected}, got {actual}")]
    Corruption { expected: u32, actual: u32 },
    #[error("Invalid Magic Bytes")]
    InvalidFormat,
    #[error("Version Mismatch: {0}")]
    VersionMismatch(u32),
}
```

### 2.2 Audit Strategy
- Grep for `unwrap()`, `expect()`, `panic!()` in `src/`.
- Replace with `?` propagation or explicit error handling.
- Ensure `impl From<IoError>` works for generic traits.

## 3. Tasks (W7.4)
- [ ] Define comprehensive `PersistenceError`.
- [ ] Refactor `WriteAheadLog` to use `PersistenceError`.
- [ ] Refactor `SnapshotManager` to use `PersistenceError`.
- [ ] Ensure errors map cleanly to `JsValue` (for future WASM).

## 4. Verification
- **Code Review:** `cargo clippy` and manual inspection.
- **Negative Tests:** Force IO errors (e.g., read-only file) and verify structured error return.

