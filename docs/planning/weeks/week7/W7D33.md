# W7D33 - Atomic Save (Two-Phase Commit)

## 1. Context
- **Objective:** Ensure that a power failure during a "Save" operation never corrupts the database.
- **Dependencies:** Snapshot Management (W7D32), `StorageBackend` trait.
- **Success Criteria:** Core logic uses `StorageBackend` abstraction; file system interruptions leave the previous valid state intact.

## 2. Technical Plan

### 2.1 StorageBackend Trait Update
To support atomicity across different backends (File vs IDB), we extend the trait:

```rust
pub trait StorageBackend: Send + Sync {
    // ... existing methods (read, write, sync) ...

    /// Write data atomically to a key/file.
    /// If the operation fails, the previous data at `key` remains valid.
    fn atomic_write(&self, key: &str, data: &[u8]) -> Result<(), PersistenceError>;
}
```

### 2.2 Backend Implementation Strategies

#### A. FileBackend (Native)
1. Write `data` to `${key}.tmp`.
2. `fsync` / `flush` to ensure data hits disk.
3. `std::fs::rename("${key}.tmp", key)` (Atomic on POSIX/Windows).
4. `fsync` parent directory.

#### B. IndexedDbBackend (WASM)
1. Open a `readwrite` Transaction.
2. Call `store.put(data, key)`.
3. Commit transaction.
(IndexedDB transactions are atomic by definition; if it fails, the put doesn't happen).

### 2.3 Core Logic Usage
The `SnapshotManager` or `WAL` rotation logic relies purely on the trait:

```rust
pub fn save_snapshot<S: StorageBackend>(backend: &S, key: &str, snapshot: &Snapshot) -> Result<()> {
    let data = serialize(snapshot)?;
    // Atomicity is delegated to the backend implementation
    backend.atomic_write(key, &data)?; 
    Ok(())
}
```
**Constraint:** The core logic calls `backend.atomic_write()`. It does **NOT** call `fs::rename` directly.

## 3. Tasks (W7.3)
- [ ] Add `atomic_write` to `StorageBackend` trait.
- [ ] Implement `atomic_write` for `FileBackend` (using tempfile + rename).
- [ ] Implement `atomic_write` for `IndexedDbBackend` (using Transaction put).
- [ ] Implement `atomic_write` for `MemoryBackend` (for testing).
- [ ] Refactor `SnapshotManager` to use `atomic_write`.

## 4. Verification
- **Integration Test:** `test_atomic_overwrite` with `FileBackend`.
- **Unit Test:** `test_atomic_overwrite` with `MemoryBackend` (simulate failure).
- **Manual/Mock:** Verify `IndexedDB` transaction usage via logic inspection or mock.
