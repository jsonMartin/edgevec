# W7D31 - WAL Replay Logic

## 1. Context
- **Objective:** Enable the system to restore state from the Write-Ahead Log (WAL) after a restart or crash.
- **Dependencies:** `WriteAheadLog` structure (created in Week 6/5 phase), `StorageBackend` trait.
- **Success Criteria:** `WAL::replay()` reads log entries and applies them to the in-memory state correctly, abstracting over the underlying storage (File or IndexedDB).

## 2. Technical Plan

### 2.1 Replay Algorithm
1. **Initialize WAL Backend** (via `StorageBackend` implementation).
2. Read header and verify magic bytes/version.
3. Iterate through entries:
    - Read length + Checksum.
    - Read payload.
    - Verify checksum (CRC32).
    - If valid: Deserialize `WalEntry` and Apply to `VectorStorage`.
    - If invalid (corruption/truncation): Stop and truncate log at last valid byte (or report error based on policy).

### 2.2 Data Structures
```rust
pub struct WalReplayResult {
    pub applied_count: usize,
    pub bytes_read: u64,
    pub truncated: bool,
}

pub struct WriteAheadLog {
    backend: Box<dyn StorageBackend>,
    // ...
}

impl WriteAheadLog {
    pub fn replay<F>(&mut self, mut applier: F) -> Result<WalReplayResult, PersistenceError>
    where F: FnMut(WalEntry) -> Result<(), PersistenceError> {
        // Implementation uses self.backend.read(...)
    }
}
```

### 2.3 WalAppender Refactor
- The `WalAppender` must operate on `Box<dyn StorageBackend>`, not a raw `File`.
- This allows `WAL` logic to run unchanged in WASM (IndexedDB) and Native (File) environments.

## 3. Tasks (W7.1)
- [ ] Refactor `WriteAheadLog` to own a `Box<dyn StorageBackend>`.
- [ ] Implement `WAL::iter()` or internal iteration for replay using the backend trait.
- [ ] Implement checksum validation logic during read.
- [ ] Handle "partial write" at end of stream (common crash scenario) gracefully.
- [ ] Test: Write 100 entries via MockBackend, close, reopen, replay, verify 100 entries.

## 4. Verification
- **Unit Test:** `test_wal_replay_integrity` using `MemoryBackend`.
- **Performance:** Measure replay speed (Target: <100ms for 10k entries).
