# W6D27: Metric Implementation (Tuesday)

**Goal:** Implement `ScalarQuantizer` and SIMD-ready `u8` metrics.

## Context
With Architecture approved, we build the core math types.

## Tasks

### 1. Scalar Quantizer (W6.2)
- **Module:** `src/quantization/scalar.rs`
- **Struct:** `ScalarQuantizer`
    - Fields: `min: Vec<f32>`, `max: Vec<f32>` (or global min/max for simple SQ8).
    - *Decision:* Start with Global Min/Max per dimension? Or Global Min/Max per vector?
    - *Plan:* **Per-Channel (Dimension) Min/Max** gives better accuracy but uses more metadata. **Global Min/Max** is easiest.
    - *Choice:* **Global Min/Max (entire dataset)** for v1 (simplest). Or just `min=0.0, max=1.0` if normalized?
    - *Refinement:* Use **min/max per dimension** if possible, but for simplicity, let's start with standard statistical ranges.

### 2. u8 Distance Metrics (W6.2)
- **Module:** `src/metric/u8.rs` (New)
- **Functions:**
    - `l2_distance_u8(a: &[u8], b: &[u8]) -> f32`
    - `cosine_similarity_u8(a: &[u8], b: &[u8]) -> f32`
- **Optimization (SIMD-First):**
    - Use `std::simd` (portable) or `core::arch::wasm32` intrinsics.
    - **Critical:** Accumulate `u8` differences into `u16` or `u32` vector lanes to prevent overflow before horizontal reduction.
    - Avoid scalar casting loop (performance killer).

### 3. Testing
- `test_quantizer_roundtrip`: f32 -> u8 -> f32. Check error margin.
- `test_metric_correspondence`: Compare `l2(f32)` vs `l2(u8)`.

## Deliverables
- [ ] `src/quantization/` module.
- [ ] `src/metric/` updated with `u8` support.
- [ ] Unit tests passing.

## Verification
- `cargo test`

