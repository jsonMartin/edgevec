# W8D38 — npm Package & Integration

**Date:** 2025-12-20
**Phase:** 5 (Release Polish)
**Owner:** WASM_SPECIALIST + DOCWRITER
**Tasks:** W8.6, W8.7, W8.8, W8.9
**Estimated Hours:** 8

---

## 1. Context

- **Objective:** Finalize npm package configuration and create integration examples for browser and Node.js environments.
- **Dependencies:** TypeScript wrapper complete (W8D37), WASM bindings stable (Phase 4).
- **Success Criteria:** `npm pack` succeeds; package.json metadata complete; examples/ directory with working samples.

---

## 2. Technical Plan

### 2.1 Package Structure

```
edgevec/
├── pkg/                         # wasm-pack output (WASM bindings)
│   ├── edgevec_bg.wasm
│   ├── edgevec.js
│   ├── edgevec.d.ts
│   └── package.json             # wasm-pack generated
├── wasm/                        # TypeScript wrapper
│   ├── EdgeVecClient.ts
│   ├── EdgeVecConfig.ts
│   ├── types.ts
│   └── index.ts
├── dist/                        # Compiled output (npm publish target)
│   ├── index.js
│   ├── index.d.ts
│   └── edgevec_bg.wasm
├── examples/                    # Usage examples
│   ├── browser/
│   │   ├── index.html
│   │   └── app.js
│   └── nodejs/
│       └── example.js
├── package.json                 # Root package config
├── .npmignore                   # Exclude from npm package
├── README.md                    # npm readme
└── LICENSE                      # MIT
```

### 2.2 npm Package Metadata Requirements

| Field | Value | Purpose |
|:------|:------|:--------|
| name | `edgevec` | npm package name |
| version | `1.0.0-alpha.1` | Semantic version (alpha) |
| description | High-performance vector search for browser, Node.js, and edge | SEO/discoverability |
| main | `dist/index.js` | CommonJS entry |
| module | `dist/index.mjs` | ESM entry |
| types | `dist/index.d.ts` | TypeScript declarations |
| files | `["dist", "pkg"]` | Included in package |
| keywords | `["vector", "search", "wasm", ...]` | npm search |
| repository | GitHub URL | Link to source |
| license | MIT | Open source |
| engines | `{"node": ">=16"}` | Compatibility |

---

## 3. Tasks

### W8.6: npm Package Metadata (2 hours)

#### 3.6.1 package.json Update

```json
{
  "name": "edgevec",
  "version": "1.0.0-alpha.1",
  "description": "High-performance vector search for browser, Node.js, and edge devices. HNSW indexing with WASM-first architecture.",
  "main": "dist/index.js",
  "module": "dist/index.mjs",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.mjs",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./wasm": {
      "import": "./pkg/edgevec.js",
      "types": "./pkg/edgevec.d.ts"
    }
  },
  "files": [
    "dist",
    "pkg",
    "README.md",
    "LICENSE"
  ],
  "keywords": [
    "vector",
    "search",
    "vector-database",
    "hnsw",
    "approximate-nearest-neighbor",
    "ann",
    "wasm",
    "webassembly",
    "browser",
    "edge",
    "embedding",
    "similarity-search",
    "knn",
    "indexeddb"
  ],
  "author": "Matteo Panzeri",
  "license": "MIT",
  "repository": {
    "type": "git",
    "url": "https://github.com/matteocrippa/edgevec"
  },
  "homepage": "https://github.com/matteocrippa/edgevec#readme",
  "bugs": {
    "url": "https://github.com/matteocrippa/edgevec/issues"
  },
  "engines": {
    "node": ">=16"
  },
  "sideEffects": false,
  "scripts": {
    "build": "wasm-pack build --target web && tsc",
    "build:node": "wasm-pack build --target nodejs",
    "test": "jest",
    "test:coverage": "jest --coverage",
    "prepublishOnly": "npm run build && npm run test"
  },
  "devDependencies": {
    "@types/jest": "^29.5.0",
    "jest": "^29.7.0",
    "ts-jest": "^29.1.0",
    "typescript": "^5.3.0"
  },
  "peerDependencies": {},
  "dependencies": {}
}
```

#### 3.6.2 Metadata Verification Checklist

- [ ] `name` is available on npm (check `npm view edgevec`)
- [ ] `version` follows semver (`1.0.0-alpha.1`)
- [ ] `description` is concise and keyword-rich
- [ ] `main`/`module`/`types` paths exist
- [ ] `files` array includes only necessary files
- [ ] `keywords` are relevant and diverse
- [ ] `repository` URL is correct
- [ ] `license` matches LICENSE file
- [ ] `engines.node` >= 16 (WASM support)

---

### W8.7: npm Package Configuration (2 hours)

#### 3.7.1 .npmignore Configuration

```
# Source files (keep compiled only)
src/
wasm/src/
*.ts
!*.d.ts

# Development files
.claude/
docs/planning/
docs/architecture/
docs/reviews/
benches/
tests/
fuzz/
examples/

# Build artifacts (keep dist/ and pkg/)
target/
*.log
.DS_Store

# Git
.git/
.gitignore

# IDE
.vscode/
.idea/
*.swp

# CI/CD
.github/
*.yml
!package.json

# Test files
__tests__/
*.test.ts
*.spec.ts
jest.config.*
coverage/

# Rust
Cargo.toml
Cargo.lock
*.rs
```

#### 3.7.2 Dry-Run Verification

```bash
# Step 1: Build package
npm run build

# Step 2: Create tarball (dry-run)
npm pack --dry-run

# Expected output:
# npm notice
# npm notice package: edgevec@1.0.0-alpha.1
# npm notice === Tarball Contents ===
# npm notice 1.2kB  dist/index.js
# npm notice 0.5kB  dist/index.d.ts
# npm notice 150kB  pkg/edgevec_bg.wasm
# npm notice 2.3kB  pkg/edgevec.js
# npm notice ...
# npm notice === Tarball Details ===
# npm notice name:          edgevec
# npm notice version:       1.0.0-alpha.1
# npm notice package size:  ~200kB
# npm notice unpacked size: ~400kB
# npm notice total files:   X

# Step 3: Verify critical files included
npm pack --dry-run 2>&1 | grep -E "(dist/|pkg/)"

# Step 4: Verify excluded files NOT included
npm pack --dry-run 2>&1 | grep -E "(src/|tests/|docs/)" && echo "ERROR: Source files included!" || echo "OK: Source files excluded"

# Step 5: Create actual tarball for inspection
npm pack
tar -tzf edgevec-1.0.0-alpha.1.tgz | head -50
```

#### 3.7.3 Package Size Verification

```bash
# Uncompressed size check
du -sh dist/ pkg/

# Gzipped WASM size (must be <500KB)
gzip -c pkg/edgevec_bg.wasm | wc -c
# Expected: <500000 bytes

# Total package size
ls -la edgevec-1.0.0-alpha.1.tgz
# Expected: <300KB
```

---

### W8.8: README Quick Start Update (2 hours)

#### 3.8.1 Complete Browser Example

```markdown
## Quick Start

### Browser (ES Modules)

```html
<!DOCTYPE html>
<html>
<head>
  <title>EdgeVec Demo</title>
</head>
<body>
  <script type="module">
    import { EdgeVecClient, EdgeVecConfigBuilder } from 'edgevec';

    async function main() {
      // 1. Create index with config builder
      const config = new EdgeVecConfigBuilder(128)
        .withMetric('cosine')
        .build();

      const db = await EdgeVecClient.create(config);
      console.log('EdgeVec initialized');

      // 2. Insert vectors
      for (let i = 0; i < 1000; i++) {
        const vector = new Float32Array(128);
        for (let j = 0; j < 128; j++) {
          vector[j] = Math.random();
        }
        await db.insert(vector);
      }
      console.log(`Inserted ${db.length} vectors`);

      // 3. Search
      const query = new Float32Array(128).fill(0.5);
      const results = await db.search(query, 10);
      console.log('Search results:', results);

      // 4. Persist to IndexedDB
      await db.save('my-vectors');
      console.log('Saved to IndexedDB');

      // 5. Load from IndexedDB
      const loaded = await EdgeVecClient.load('my-vectors', config);
      console.log(`Loaded ${loaded.length} vectors`);
    }

    main().catch(console.error);
  </script>
</body>
</html>
```

### Node.js

```javascript
const { EdgeVecClient } = require('edgevec');

async function main() {
  // Create index
  const db = await EdgeVecClient.create({ dimensions: 128 });

  // Insert vectors
  const vectors = [];
  for (let i = 0; i < 1000; i++) {
    const vec = new Float32Array(128);
    for (let j = 0; j < 128; j++) {
      vec[j] = Math.random();
    }
    await db.insert(vec);
  }

  // Search
  const query = new Float32Array(128).fill(0.5);
  const results = await db.search(query, 10);

  console.log('Top 10 results:');
  results.forEach((r, i) => {
    console.log(`  ${i + 1}. ID: ${r.id}, Distance: ${r.distance.toFixed(4)}`);
  });
}

main();
```

### Rust

```rust
use edgevec::{HnswConfig, HnswIndex, VectorStorage};

fn main() -> Result<(), Box<dyn std::error::Error>> {
    // Create config & storage
    let config = HnswConfig::new(128);
    let mut storage = VectorStorage::new(&config, None);

    // Create index
    let mut index = HnswIndex::new(config, &storage)?;

    // Insert vectors
    for _ in 0..1000 {
        let vec: Vec<f32> = (0..128).map(|_| rand::random()).collect();
        index.insert(&vec, &mut storage)?;
    }

    // Search
    let query: Vec<f32> = vec![0.5; 128];
    let results = index.search(&query, 10, &storage)?;

    for (i, result) in results.iter().enumerate() {
        println!("{}. ID: {}, Distance: {:.4}", i + 1, result.id, result.distance);
    }

    Ok(())
}
```
```

#### 3.8.2 README Section Verification

- [ ] Installation instructions (`npm install edgevec`)
- [ ] Browser usage example (complete, working)
- [ ] Node.js usage example (complete, working)
- [ ] Rust usage example (updated to current API)
- [ ] API reference link
- [ ] Performance section with benchmarks
- [ ] License section

---

### W8.9: Examples Directory Creation (2 hours)

#### 3.9.1 Browser Example

```
examples/browser/
├── index.html           # Main demo page
├── app.js               # Application logic
├── styles.css           # Basic styling
└── README.md            # Browser-specific instructions
```

**index.html:**
```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EdgeVec Browser Demo</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <h1>EdgeVec Browser Demo</h1>

    <section id="controls">
      <button id="init-btn">Initialize (128D)</button>
      <button id="insert-btn" disabled>Insert 1000 Vectors</button>
      <button id="search-btn" disabled>Search (k=10)</button>
      <button id="save-btn" disabled>Save to IndexedDB</button>
      <button id="load-btn">Load from IndexedDB</button>
    </section>

    <section id="output">
      <pre id="log"></pre>
    </section>

    <section id="results">
      <h2>Search Results</h2>
      <table id="results-table">
        <thead>
          <tr><th>Rank</th><th>ID</th><th>Distance</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
```

**app.js:**
```javascript
import { EdgeVecClient, EdgeVecConfigBuilder } from 'edgevec';

let db = null;
const config = new EdgeVecConfigBuilder(128).withMetric('cosine').build();

const log = (msg) => {
  document.getElementById('log').textContent += msg + '\n';
};

document.getElementById('init-btn').addEventListener('click', async () => {
  const start = performance.now();
  db = await EdgeVecClient.create(config);
  const elapsed = (performance.now() - start).toFixed(2);
  log(`Initialized in ${elapsed}ms`);
  document.querySelectorAll('button').forEach(b => b.disabled = false);
});

document.getElementById('insert-btn').addEventListener('click', async () => {
  const start = performance.now();
  for (let i = 0; i < 1000; i++) {
    const vec = new Float32Array(128);
    for (let j = 0; j < 128; j++) vec[j] = Math.random();
    await db.insert(vec);
  }
  const elapsed = (performance.now() - start).toFixed(2);
  log(`Inserted 1000 vectors in ${elapsed}ms (${db.length} total)`);
});

document.getElementById('search-btn').addEventListener('click', async () => {
  const query = new Float32Array(128).fill(0.5);
  const start = performance.now();
  const results = await db.search(query, 10);
  const elapsed = (performance.now() - start).toFixed(2);
  log(`Search completed in ${elapsed}ms`);

  const tbody = document.querySelector('#results-table tbody');
  tbody.innerHTML = '';
  results.forEach((r, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `<td>${i + 1}</td><td>${r.id}</td><td>${r.distance.toFixed(6)}</td>`;
    tbody.appendChild(row);
  });
});

document.getElementById('save-btn').addEventListener('click', async () => {
  const start = performance.now();
  await db.save('demo-db');
  const elapsed = (performance.now() - start).toFixed(2);
  log(`Saved to IndexedDB in ${elapsed}ms`);
});

document.getElementById('load-btn').addEventListener('click', async () => {
  const start = performance.now();
  db = await EdgeVecClient.load('demo-db', config);
  const elapsed = (performance.now() - start).toFixed(2);
  log(`Loaded from IndexedDB in ${elapsed}ms (${db.length} vectors)`);
  document.querySelectorAll('button').forEach(b => b.disabled = false);
});
```

#### 3.9.2 Node.js Example

```
examples/nodejs/
├── example.js           # Basic usage
├── benchmark.js         # Performance test
├── persistence.js       # Save/load demo
└── README.md            # Node-specific instructions
```

**example.js:**
```javascript
const { EdgeVecClient, EdgeVecConfigBuilder } = require('edgevec');

async function main() {
  console.log('EdgeVec Node.js Example\n');

  // 1. Configuration
  const config = new EdgeVecConfigBuilder(128)
    .withMetric('l2')
    .withQuantization('sq8')
    .build();

  console.log('Config:', config);

  // 2. Create instance
  const db = await EdgeVecClient.create(config);
  console.log('Instance created');

  // 3. Insert vectors
  const insertStart = process.hrtime.bigint();
  for (let i = 0; i < 10000; i++) {
    const vec = new Float32Array(128);
    for (let j = 0; j < 128; j++) {
      vec[j] = Math.random();
    }
    await db.insert(vec);
  }
  const insertElapsed = Number(process.hrtime.bigint() - insertStart) / 1e6;
  console.log(`Inserted 10,000 vectors in ${insertElapsed.toFixed(2)}ms`);

  // 4. Search benchmark
  const query = new Float32Array(128).fill(0.5);
  const searchStart = process.hrtime.bigint();
  const results = await db.search(query, 10);
  const searchElapsed = Number(process.hrtime.bigint() - searchStart) / 1e6;

  console.log(`\nSearch completed in ${searchElapsed.toFixed(2)}ms`);
  console.log('Top 10 results:');
  results.forEach((r, i) => {
    console.log(`  ${i + 1}. ID: ${r.id}, Distance: ${r.distance.toFixed(6)}`);
  });

  // 5. Memory stats
  const used = process.memoryUsage();
  console.log(`\nMemory Usage:`);
  console.log(`  Heap Used: ${(used.heapUsed / 1024 / 1024).toFixed(2)} MB`);
  console.log(`  External: ${(used.external / 1024 / 1024).toFixed(2)} MB`);
}

main().catch(console.error);
```

---

## 4. Verification

### 4.1 Automated Checks

```bash
# npm pack verification
npm pack --dry-run

# Package size check
npm pack
ls -la edgevec-*.tgz

# Verify WASM bundle size
gzip -c pkg/edgevec_bg.wasm | wc -c

# Test installation from tarball
mkdir test-install && cd test-install
npm init -y
npm install ../edgevec-1.0.0-alpha.1.tgz
node -e "const e = require('edgevec'); console.log('Import works:', typeof e.EdgeVecClient)"
```

### 4.2 Manual Testing

- [ ] Browser example loads in Chrome
- [ ] Browser example loads in Firefox
- [ ] Browser example loads in Safari
- [ ] Node.js example runs without errors
- [ ] README examples copy-paste and work

### 4.3 Acceptance Criteria

| Criterion | Test | Status |
|:----------|:-----|:-------|
| package.json valid | `npm pack` succeeds | [ ] |
| .npmignore working | Source files excluded from tarball | [ ] |
| Bundle <500KB | `gzip -c pkg/*.wasm \| wc -c` < 500000 | [ ] |
| Browser example works | Manual test | [ ] |
| Node.js example works | Manual test | [ ] |
| README examples accurate | Copy-paste test | [ ] |

---

## 5. Deliverables

| Artifact | Location | Status |
|:---------|:---------|:-------|
| package.json | `package.json` | [ ] |
| .npmignore | `.npmignore` | [ ] |
| Updated README | `README.md` | [ ] |
| Browser example | `examples/browser/` | [ ] |
| Node.js example | `examples/nodejs/` | [ ] |

---

## 6. Risks & Mitigations

| Risk | Mitigation |
|:-----|:-----------|
| npm name already taken | Check availability early; have backup name |
| Package too large | Verify .npmignore excludes tests/docs |
| Browser incompatibility | Test all major browsers |

---

## 7. Next Step

> After completion: Proceed to **W8D39 (Final Benchmarks & Validation)**
> Required review: HOSTILE_REVIEWER verifies npm package integrity

---

**END OF W8D38**
